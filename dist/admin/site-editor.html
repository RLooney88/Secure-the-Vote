<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Site Editor - Admin Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #1a1a1a;
      color: #fff;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: #2a2a2a;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #3a3a3a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-left h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .header-left p {
      font-size: 0.875rem;
      color: #888;
      margin-top: 0.25rem;
    }
    
    .header-right {
      display: flex;
      gap: 0.75rem;
    }
    
    .upload-btn {
      background: #3a3a3a;
      color: #fff;
      border: 1px solid #4a4a4a;
      border-radius: 0.5rem;
      padding: 0.625rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }
    
    .upload-btn:hover {
      background: #4a4a4a;
      border-color: #5a5a5a;
    }
    
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 1rem;
      overflow: hidden;
    }
    
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .message {
      display: flex;
      gap: 1rem;
      max-width: 80%;
      animation: slideIn 0.2s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    
    .message.assistant {
      align-self: flex-start;
    }
    
    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #9B1E37;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
      flex-shrink: 0;
    }
    
    .message.user .message-avatar {
      background: #F6BF58;
      color: #1a1a1a;
    }
    
    .message-content {
      background: #2a2a2a;
      padding: 0.875rem 1.125rem;
      border-radius: 1rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    
    .message.user .message-content {
      background: #F6BF58;
      color: #1a1a1a;
    }
    
    .input-container {
      padding: 1rem;
      background: #2a2a2a;
      border-top: 1px solid #3a3a3a;
    }
    
    .input-wrapper {
      display: flex;
      gap: 0.75rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .input-wrapper textarea {
      flex: 1;
      background: #1a1a1a;
      border: 1px solid #3a3a3a;
      border-radius: 0.5rem;
      padding: 0.875rem;
      color: #fff;
      font-size: 0.9375rem;
      font-family: inherit;
      resize: none;
      min-height: 52px;
      max-height: 150px;
    }
    
    .input-wrapper textarea:focus {
      outline: none;
      border-color: #9B1E37;
    }
    
    .input-wrapper button {
      background: #9B1E37;
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      padding: 0 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .input-wrapper button:hover:not(:disabled) {
      background: #7a1829;
    }
    
    .input-wrapper button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .attach-btn {
      background: #3a3a3a;
      color: #888;
      border: 1px solid #4a4a4a;
      border-radius: 0.5rem;
      width: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .attach-btn:hover {
      background: #4a4a4a;
      color: #fff;
      border-color: #5a5a5a;
    }

    .attach-btn svg {
      width: 20px;
      height: 20px;
    }

    .chat-attachments {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
      padding: 0 0.5rem;
    }

    .chat-attachment-preview {
      position: relative;
      display: inline-flex;
      align-items: center;
      background: #1a1a1a;
      border: 1px solid #3a3a3a;
      border-radius: 0.5rem;
      padding: 0.25rem;
      gap: 0.5rem;
    }

    .chat-attachment-preview img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 0.375rem;
    }

    .chat-attachment-preview .remove-attachment {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      background: #9B1E37;
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .chat-attachment-preview .remove-attachment:hover {
      background: #7a1829;
    }

    .drop-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(155, 30, 55, 0.1);
      border: 2px dashed #9B1E37;
      border-radius: 0.5rem;
      display: none;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .drop-overlay.active {
      display: flex;
    }

    .drop-overlay span {
      background: #2a2a2a;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      color: #9B1E37;
      font-weight: 500;
    }
    
    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .ai-status {
      color: #888;
      font-style: italic;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .ai-status::before {
      content: '';
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #888;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .actions button {
      background: #3a3a3a;
      color: #fff;
      border: 1px solid #4a4a4a;
      border-radius: 0.375rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .actions button:hover {
      background: #4a4a4a;
      border-color: #5a5a5a;
    }
    
    .actions button.primary {
      background: #F6BF58;
      color: #1a1a1a;
      border-color: #F6BF58;
    }
    
    .actions button.primary:hover {
      background: #e5ae47;
      border-color: #e5ae47;
    }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #666;
    }
    
    .empty-state h2 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: #888;
    }
    
    .empty-state p {
      font-size: 0.9375rem;
    }
    
    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: #2a2a2a;
      border-radius: 1rem;
      width: 90%;
      max-width: 480px;
      padding: 1.5rem;
      border: 1px solid #3a3a3a;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
    }
    
    .modal-header h3 {
      font-size: 1.125rem;
      font-weight: 600;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
      line-height: 1;
    }
    
    .close-btn:hover {
      color: #fff;
    }
    
    .upload-zone {
      border: 2px dashed #4a4a4a;
      border-radius: 0.75rem;
      padding: 2rem;
      text-align: center;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: #9B1E37;
      background: rgba(155, 30, 55, 0.1);
    }
    
    .upload-zone p {
      margin-top: 0.75rem;
      color: #888;
      font-size: 0.9375rem;
    }
    
    .upload-hint {
      font-size: 0.8125rem !important;
      color: #666 !important;
      margin-top: 0.5rem !important;
    }
    
    .browse-link {
      color: #9B1E37;
      cursor: pointer;
      text-decoration: underline;
    }
    
    .upload-icon {
      color: #666;
    }
    
    .upload-preview {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: #1a1a1a;
      border-radius: 0.5rem;
      margin-top: 1rem;
    }
    
    .upload-preview img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 0.375rem;
    }
    
    .upload-preview span {
      font-size: 0.875rem;
      color: #ccc;
      word-break: break-all;
    }
    
    .upload-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }
    
    .cancel-btn {
      background: #3a3a3a;
      color: #fff;
      border: 1px solid #4a4a4a;
      border-radius: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .cancel-btn:hover {
      background: #4a4a4a;
    }
    
    .upload-btn-primary {
      background: #9B1E37;
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      padding: 0.625rem 1.25rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .upload-btn-primary:hover:not(:disabled) {
      background: #7a1829;
    }
    
    .upload-btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Gallery Section */
    .gallery-section {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 600px;
      background: #2a2a2a;
      border-radius: 1rem 1rem 0 0;
      border: 1px solid #3a3a3a;
      border-bottom: none;
      max-height: 50vh;
      display: flex;
      flex-direction: column;
      z-index: 500;
    }
    
    .gallery-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #3a3a3a;
    }
    
    .gallery-header h4 {
      font-size: 1rem;
      font-weight: 600;
    }
    
    .gallery-close {
      background: none;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
      line-height: 1;
    }
    
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.75rem;
      padding: 1rem;
      overflow-y: auto;
    }
    
    .gallery-item {
      position: relative;
      border-radius: 0.5rem;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .gallery-item:hover {
      transform: scale(1.05);
    }
    
    .gallery-item img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }
    
    .gallery-item-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.8);
      padding: 0.25rem 0.5rem;
      font-size: 0.6875rem;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .gallery-empty {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <h1>Site Editor AI</h1>
      <p>Natural language editing for Secure The Vote MD</p>
    </div>
    <div class="header-right">
      <button class="upload-btn" onclick="openUploadDialog()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Upload Image
      </button>
    </div>
  </div>
  
  <!-- Upload Dialog Modal -->
  <div id="uploadModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Upload Image</h3>
        <button class="close-btn" onclick="closeUploadDialog()">&times;</button>
      </div>
      <div class="upload-zone" id="dropZone">
        <div class="upload-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        </div>
        <p>Drag & drop an image here, or <label for="fileInput" class="browse-link">browse</label></p>
        <p class="upload-hint">JPG, PNG, GIF, WEBP, SVG, PDF, DOC, DOCX (max 10MB)</p>
        <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx" hidden>
      </div>
      <div id="uploadPreview" class="upload-preview" style="display: none;">
        <img id="previewImg" src="" alt="Preview">
        <span id="previewName"></span>
      </div>
      <div class="upload-actions">
        <button class="cancel-btn" onclick="closeUploadDialog()">Cancel</button>
        <button class="upload-btn-primary" id="uploadSubmitBtn" onclick="uploadFile()" disabled>Upload</button>
      </div>
    </div>
  </div>
  
  <!-- Gallery Section -->
  <div id="gallerySection" class="gallery-section" style="display: none;">
    <div class="gallery-header">
      <h4>Recent Uploads</h4>
      <button class="gallery-close" onclick="closeGallery()">&times;</button>
    </div>
    <div class="gallery-grid" id="galleryGrid"></div>
  </div>
  
  <div class="chat-container">
    <div class="messages" id="messages">
      <div class="empty-state">
        <h2>Welcome to Site Editor</h2>
        <p>Ask me to edit your site, add new pages, update content, or make design changes.</p>
      </div>
    </div>
  </div>
  
  <div class="input-container">
    <div class="input-wrapper" style="position: relative;">
      <textarea
        id="input"
        placeholder="Ask the AI to edit your site... (e.g., 'Add a new Donate page with a payment form')"
        rows="1"
      ></textarea>
      <div class="drop-overlay" id="dropOverlay">
        <span>Drop image here</span>
      </div>
      <div class="chat-attachments" id="chatAttachments"></div>
      <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
        <button class="attach-btn" onclick="document.getElementById('chatFileInput').click()" title="Attach image">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
          </svg>
        </button>
        <input type="file" id="chatFileInput" accept="image/*" hidden>
        <button id="send" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
  
  <script>
    const API_URL = 'https://site-builder-ai-production.up.railway.app';
    const SITE_ID = 'securethevotemd';

    let isLoading = false;
    let selectedFile = null;
    let uploadedFiles = [];
    let chatAttachments = []; // Images attached to current message
    
    // Auto-resize textarea
    const textarea = document.getElementById('input');
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });
    
    // Enter to send (Shift+Enter for new line)
    textarea.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Chat attachment handlers
    const chatFileInput = document.getElementById('chatFileInput');
    const dropOverlay = document.getElementById('dropOverlay');

    chatFileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleChatAttachment(e.target.files[0]);
      }
    });

    // Paste handler for images
    textarea.addEventListener('paste', async (e) => {
      const items = e.clipboardData?.items;
      if (!items) return;

      for (const item of items) {
        if (item.type.indexOf('image') !== -1) {
          e.preventDefault();
          const file = item.getAsFile();
          if (file) {
            handleChatAttachment(file);
          }
          break;
        }
      }
    });

    // Drag and drop on textarea
    textarea.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropOverlay.classList.add('active');
    });

    textarea.addEventListener('dragleave', () => {
      dropOverlay.classList.remove('active');
    });

    textarea.addEventListener('drop', (e) => {
      e.preventDefault();
      dropOverlay.classList.remove('active');

      const files = e.dataTransfer?.files;
      if (files && files.length > 0) {
        const imageFile = Array.from(files).find(f => f.type.startsWith('image/'));
        if (imageFile) {
          handleChatAttachment(imageFile);
        }
      }
    });

    function handleChatAttachment(file) {
      if (!file.type.startsWith('image/')) {
        alert('Please attach an image file');
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        alert('Image must be under 5MB');
        return;
      }

      const attachment = {
        id: Date.now(),
        file: file,
        preview: URL.createObjectURL(file)
      };

      chatAttachments.push(attachment);
      renderChatAttachments();
    }

    function renderChatAttachments() {
      const container = document.getElementById('chatAttachments');
      container.innerHTML = chatAttachments.map(att => `
        <div class="chat-attachment-preview">
          <img src="${att.preview}" alt="Attachment">
          <button class="remove-attachment" onclick="removeChatAttachment(${att.id})">√ó</button>
        </div>
      `).join('');
    }

    function removeChatAttachment(id) {
      const att = chatAttachments.find(a => a.id === id);
      if (att) {
        URL.revokeObjectURL(att.preview);
        chatAttachments = chatAttachments.filter(a => a.id !== id);
        renderChatAttachments();
      }
    }
    
    async function sendMessage() {
      const input = document.getElementById('input');
      const message = input.value.trim();

      if ((!message && chatAttachments.length === 0) || isLoading) return;

      // Upload images first if any attachments
      let imageUrls = [];
      if (chatAttachments.length > 0) {
        for (const att of chatAttachments) {
          try {
            const formData = new FormData();
            formData.append('file', att.file);
            formData.append('context', 'media');

            const res = await fetch(`${API_URL}/sites/${SITE_ID}/upload`, {
              method: 'POST',
              body: formData
            });
            const data = await res.json();
            if (data.success && data.url) {
              const fullUrl = `https://site-builder-ai-production.up.railway.app${data.url}`;
              imageUrls.push(fullUrl);
            }
          } catch (err) {
            console.error('Image upload error:', err);
          }
        }

        // Clear attachments after upload
        chatAttachments.forEach(att => URL.revokeObjectURL(att.preview));
        chatAttachments = [];
        renderChatAttachments();
      }

      // Clear input
      input.value = '';
      input.style.height = 'auto';

      // Remove empty state
      const emptyState = document.querySelector('.empty-state');
      if (emptyState) emptyState.remove();

      // Add user message with images
      const userContent = imageUrls.length > 0
        ? { text: message, images: imageUrls }
        : message;
      addMessage('user', message);

      // Show images in the message if any
      if (imageUrls.length > 0) {
        const lastMsg = document.querySelector('.message.user:last-child .message-content');
        imageUrls.forEach(url => {
          const img = document.createElement('img');
          img.src = url;
          img.style.maxWidth = '200px';
          img.style.borderRadius = '0.5rem';
          img.style.marginTop = '0.5rem';
          lastMsg.appendChild(img);
        });
      }

      // Show loading with status indicator
      isLoading = true;
      document.getElementById('send').disabled = true;
      document.getElementById('send').innerHTML = '<span class="loading"></span>';

      // Add a status message that we'll update in real-time
      const statusId = 'status-' + Date.now();
      addMessage('assistant', '<span class="ai-status" id="' + statusId + '">Thinking...</span>', true);
      const statusEl = document.getElementById(statusId);

      try {
        // Use SSE streaming for live status updates
        const res = await fetch(`${API_URL}/sites/${SITE_ID}/chat?stream=true`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream' },
          body: JSON.stringify({
            message,
            images: imageUrls.length > 0 ? imageUrls : undefined
          })
        });

        if (!res.ok) {
          const errData = await res.json();
          throw new Error(errData.error || 'Request failed');
        }
        
        // Read the SSE stream
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let finalMessage = '';
        let buffer = '';
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop(); // Keep incomplete line in buffer
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const event = JSON.parse(line.slice(6));
                if (event.type === 'status') {
                  // Tool activity ‚Äî show as spinner status
                  const el = document.getElementById(statusId);
                  if (el) el.textContent = event.status;
                } else if (event.type === 'progress') {
                  // AI's intermediate text ‚Äî show as status (first ~80 chars)
                  const el = document.getElementById(statusId);
                  if (el) {
                    const short = event.text.length > 80 ? event.text.slice(0, 80) + '...' : event.text;
                    el.textContent = short;
                  }
                } else if (event.type === 'done') {
                  finalMessage = event.message;
                }
              } catch (e) {}
            }
          }
        }
        
        // Replace status message with final response
        const statusMsg = statusEl?.closest('.message');
        if (statusMsg) statusMsg.remove();
        
        if (finalMessage) {
          addMessage('assistant', finalMessage);
          
          // Check if this was an edit action - show preview/approve buttons
          if (finalMessage.includes('Preview') || finalMessage.includes('updated') || finalMessage.includes('changed')) {
            addActions();
          }
        } else {
          addMessage('assistant', 'Something went wrong ‚Äî no response received. Try again?');
        }
        
      } catch (error) {
        console.error('Error:', error);
        const statusMsg = statusEl?.closest('.message');
        if (statusMsg) statusMsg.remove();
        addMessage('assistant', `Error: ${error.message}`);
      } finally {
        isLoading = false;
        document.getElementById('send').disabled = false;
        document.getElementById('send').textContent = 'Send';
      }
    }
    
    function addMessage(role, content, useHTML = false) {
      const messages = document.getElementById('messages');
      
      const message = document.createElement('div');
      message.className = `message ${role}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = role === 'user' ? 'You' : 'AI';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      if (useHTML) {
        messageContent.innerHTML = content;
      } else {
        messageContent.textContent = content;
      }
      
      message.appendChild(avatar);
      message.appendChild(messageContent);
      
      messages.appendChild(message);
      messages.scrollTop = messages.scrollHeight;
    }
    
    function addActions() {
      const messages = document.getElementById('messages');
      const lastMessage = messages.lastElementChild;
      
      const actions = document.createElement('div');
      actions.className = 'actions';
      actions.innerHTML = `
        <button onclick="createPreview()">Preview Changes</button>
        <button class="primary" onclick="approveChanges()">Publish Changes</button>
      `;
      
      lastMessage.querySelector('.message-content').appendChild(actions);
    }
    
    function createPreview() {
      // Trigger the parent dashboard's Preview Edits modal (with deployment polling)
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ action: 'preview' }, '*');
        addMessage('assistant', 'Opening preview ‚Äî check the deployment progress popup!');
      } else {
        // Fallback if not in iframe
        window.open('https://secure-the-vote-git-staging-rcl-integrated.vercel.app', '_blank');
        addMessage('assistant', 'Preview opened in a new tab.');
      }
    }
    
    function approveChanges() {
      // Trigger the parent dashboard's Publish Edits modal (with deployment polling)
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ action: 'publish' }, '*');
        addMessage('assistant', 'Publishing ‚Äî check the deployment progress popup!');
      } else {
        // Fallback if not in iframe
        if (!confirm('Publish all changes to the live site?')) return;
        fetch(`${API_URL}/sites/${SITE_ID}/publish`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        }).then(r => r.json()).then(data => {
          addMessage('assistant', 'Changes published! The live site will update in about 30 seconds.');
        }).catch(err => {
          addMessage('assistant', `Publish error: ${err.message}`);
        });
      }
    }
    
    // Load chat history on page load
    async function loadHistory() {
      try {
        const res = await fetch(`${API_URL}/sites/${SITE_ID}/history`);
        const data = await res.json();
        
        if (data.messages && data.messages.length > 0) {
          document.querySelector('.empty-state')?.remove();
          
          data.messages.forEach(msg => {
            addMessage(msg.role, msg.content);
          });
        }
      } catch (error) {
        console.log('No history loaded:', error.message);
      }
    }
    
    loadHistory();
    
    // Load uploads on page load
    loadUploads();
    
    // Upload Dialog Functions
    function openUploadDialog() {
      document.getElementById('uploadModal').style.display = 'flex';
      document.getElementById('dropZone').classList.remove('dragover');
      resetUploadDialog();
    }
    
    function closeUploadDialog() {
      document.getElementById('uploadModal').style.display = 'none';
      resetUploadDialog();
    }
    
    function resetUploadDialog() {
      selectedFile = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('uploadPreview').style.display = 'none';
      document.getElementById('uploadSubmitBtn').disabled = true;
    }
    
    // File input handlers
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
      }
    });
    
    dropZone.addEventListener('click', () => {
      fileInput.click();
    });
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) {
        handleFileSelect(e.dataTransfer.files[0]);
      }
    });
    
    function handleFileSelect(file) {
      // Validate file size (10MB max)
      if (file.size > 10 * 1024 * 1024) {
        alert('File size exceeds 10MB limit');
        return;
      }
      
      selectedFile = file;
      
      // Show preview
      const preview = document.getElementById('uploadPreview');
      const previewImg = document.getElementById('previewImg');
      const previewName = document.getElementById('previewName');
      
      preview.style.display = 'flex';
      
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          previewImg.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        previewImg.src = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>');
        previewImg.style.display = 'block';
      }
      
      previewName.textContent = file.name;
      document.getElementById('uploadSubmitBtn').disabled = false;
    }
    
    async function uploadFile() {
      if (!selectedFile) return;
      
      const submitBtn = document.getElementById('uploadSubmitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Uploading...';
      
      try {
        const formData = new FormData();
        formData.append('file', selectedFile);
        
        // Feature 3: Add context parameter
        // Uploads in the chat interface are "chat" context (temporary reference photos)
        // They don't get committed to GitHub, just stored temporarily
        formData.append('context', 'chat');
        
        // Optional: include session ID if we want to track which session uploaded what
        // For now, we'll leave it as undefined (backend can handle it)
        
        const res = await fetch(`${API_URL}/sites/${SITE_ID}/upload`, {
          method: 'POST',
          body: formData
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || 'Upload failed');
        }
        
        // Success!
        closeUploadDialog();
        
        // Different message based on context
        if (data.context === 'chat') {
          addMessage('assistant', `‚úÖ Reference image uploaded!\n\nüìÅ Temporary URL: \`${data.referenceUrl}\`\n\nüí° This image is stored temporarily (30 days) for you to reference in our conversation. Ask me to use it in your site design!`);
        } else {
          addMessage('assistant', `‚úÖ Image uploaded successfully!\n\nüìÅ Path: \`${data.url}\`\n\nCopy this path when asking the AI to include this image in your site.`);
        }
        
        // Refresh gallery (only media context files will appear)
        loadUploads();
        showGallery();
        
      } catch (error) {
        console.error('Upload error:', error);
        alert(`Upload failed: ${error.message}`);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Upload';
      }
    }
    
    // Gallery Functions
    async function loadUploads() {
      try {
        const res = await fetch(`${API_URL}/sites/${SITE_ID}/uploads`);
        const data = await res.json();
        
        if (res.ok && data.files) {
          uploadedFiles = data.files;
        }
      } catch (error) {
        console.log('Could not load uploads:', error.message);
      }
    }
    
    function showGallery() {
      const gallery = document.getElementById('gallerySection');
      const grid = document.getElementById('galleryGrid');
      
      gallery.style.display = 'flex';
      
      if (uploadedFiles.length === 0) {
        grid.innerHTML = '<div class="gallery-empty">No uploads yet</div>';
        return;
      }
      
      grid.innerHTML = uploadedFiles.map(file => {
        const isImage = file.name.match(/\.(jpg|jpeg|png|gif|webp|svg)$/i);
        const previewUrl = isImage 
          ? `https://site-builder-ai-production.up.railway.app${file.url}`
          : 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>');
        
        return `
          <div class="gallery-item" onclick="copyUploadUrl('${file.url}')" title="${file.name}">
            <img src="${previewUrl}" alt="${file.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23666%22 stroke-width=%221.5%22%3E%3Cpath d=%22M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z%22%3E%3C/path%3E%3Cpolyline points=%2214 2 14 8 20 8%22%3E%3C/polyline%3E%3C/svg%3E'">
            <div class="gallery-item-name">${file.name}</div>
          </div>
        `;
      }).join('');
    }
    
    function closeGallery() {
      document.getElementById('gallerySection').style.display = 'none';
    }
    
    function copyUploadUrl(url) {
      const fullUrl = `https://site-builder-ai-production.up.railway.app${url}`;
      navigator.clipboard.writeText(fullUrl).then(() => {
        // Brief visual feedback
        const item = event.currentTarget;
        item.style.transform = 'scale(1.1)';
        setTimeout(() => {
          item.style.transform = '';
        }, 200);
      }).catch(() => {
        // Fallback
        prompt('Copy this URL:', fullUrl);
      });
    }
  </script>
</body>
</html>
